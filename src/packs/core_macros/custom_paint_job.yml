_id: angOaW77n9ZZZqgq
name: Custom Paint Job
type: script
author: 2a2IgZ2kiAqXSGqu
img: systems/lancer/assets/icons/macro-icons/system.svg
scope: global
command: >-
  // This macro is designed to be used with Triggler from Combat Utility Belt.
  Otherwise, it can be used as an alternative to manually using the Structure
  macro. It also includes "destroying" the Custom Paint Job system in order to
  check if it's been used between full repairs.


  let cpjActor = game.actors.get(canvas.tokens.controlled[0].actor.id);

  //console.log(cpjActor);


  async function scratchedThePaint(cpjId) {
      await cpjActor.update({data: {"hp.value": 1}});
      //console.log(cpjActor)
      await cpjActor.updateEmbeddedDocuments("Item",[{_id: cpjId, 'system.destroyed':true}])
      return "Done.";
  };


  if (canvas.tokens.controlled.length !== 1) {
      ui.notifications.error("Select one and only one token");
      return;
  }


  let cpj = cpjActor.items.find(
      i => i.name.toLowerCase() === "custom paint job"
  );

  if (cpj) {
      if (!cpj.system.destroyed) {
          console.log("Custom Paint Job found.");
          let roll = new Roll('1d6');
          await roll.roll();
          console.log(`CPJ rolled ${roll.total}`);
          if (roll.total === 6) {
              await scratchedThePaint(cpj._id)
              canvas.tokens.controlled[0].drawBars();
          } else {
              game.lancer.prepareStructureMacro(cpjActor.id);
          }
          return;
      } else {
          console.log("Custom Paint Job has already been used.");
      }
  }

  // If we reach here, either the actor doesn't have CPJ or it's already been
  used.

  game.lancer.prepareStructureMacro(canvas.tokens.controlled[0].actor.id);

  canvas.tokens.controlled[0].drawBars();
folder: null
sort: 0
permission:
  default: 0
  2a2IgZ2kiAqXSGqu: 3
flags: {}
_key: "!macros!angOaW77n9ZZZqgq"
